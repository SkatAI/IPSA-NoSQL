# Pratique guid√©e sur MongoDB Atlas

Dans ce document nous allons travailler sur MongoDB Atlas, un service h√©berg√© de MongoDB pour cr√©er une base de donn√©es, charger des documents et executer des requ√™tes.

Dans un second temps nous verrons comment trravailler sur une base de donn√©es plus cons√©quente en Python ou dans le terminal avec `mongosh`.

√Ä la fin de cette session, vous devriez avoir une bonne compr√©hension du langage de requ√™te de MongoDB (MQL).

Objectifs :

- Vous vous connectez √† un serveur MongoDB Atlas
- Vous cr√©ez une base de donn√©es et vous ins√©rez des documents
- Vous construisez des requ√™tes relativement complexes sur une base de donn√©es MongoDB

## Plusieurs fa√ßons de travailler avec MongoDB

Sur votre machine locale

- [MongoDB Community Edition](https://www.mongodb.com/products/self-managed/community-edition) = Auto-h√©berg√©, s'ex√©cute sur votre ordinateur

- [MongoDB Compass](https://www.mongodb.com/products/tools/compass) - l'outil GUI pour la visualisation
- [`mongosh`](https://www.mongodb.com/docs/mongodb-shell/) le CLI dans le terminal.
Le MongoDB Shell, mongosh, est un environnement  JavaScript et Node.js **REPL** (Read-Eval-Print Loop) pour interagir avec des serveurs MongoDB d√©ploy√©s sur Atlas ou ailleurs.

Vous pouvez √©galement travailler avec votre langage de script pr√©f√©r√© : python, node.js, go, ruby, PHP, Java, etc...

Aujourd'hui, nous travaillons sur la version h√©berg√©e Atlas.

- [MongoDB Atlas](https://www.mongodb.com/lp/cloud/atlas/try4-reg) fournit un service h√©berg√© dans le Cloud avec des niveaux gratuits et payants.

Atlas nous donne un cluster h√©berg√© sur lequel nous pouvons cr√©er une base de donn√©es, importer des **collections** d'exemples et comprendre comment effectuer des op√©rations CRUD dans MongoDB. Vous n'avez besoin de rien installer.

> **CRUD** signifie Create, Read, Update et Delete : les quatre op√©rations de base pour un SGBD

## Atlas

Commen√ßons par cr√©er un compte sur Atlas <https://www.mongodb.com/cloud/atlas/register>

Ensuite :

- Cr√©ez un cluster et un projet (j'ai appel√© mon projet `Sandbox`)

![Create a cluster](./../img/create_new_cluster.png)

### Important

- **Copiez votre mot de passe de base de donn√©es**.

Il est pr√©f√©rable de le d√©finir comme variable d'environnement ou dans un fichier `.env` (pour python).

- V√©rifiez que votre **IP** est ajout√©e √† la liste, visitez `Network Access` (navigation de gauche)
- autorisez l'acc√®s depuis n'importe quelle IP en utilisant 0.0.0.0/0 (ce qui est d√©conseill√© pour la production).

![add IP address](./../img/atlas_add_ip_address.png)

### Ensuite

- Allez dans `clusters`
- Cr√©ez une base de donn√©es : ajoutez le nom `songsdb` et le nom de collection `songs`,


Note: ne pas confondre
- le projet : `Sandbox`
- la base de donn√©es: `songsdb`
- la collection (table): `songs`

Puis ins√©rez le Document suivant

```json
{
  "_id":{
    "$oid":"6745ab6f0e0bbdab062667c7"
    },
    "title": "Happy",
    "artist": "Pharrell Williams",
    "year": 2013,
    "mood": "joyful"
}
```

![insert a document](./../img/atlas_insert_document.png)

Et ins√©rez-en un autre

```json
{
  "_id":{
    "$oid":"abcdeab6f0e0bbdab062667aa"
  },
  "title": "Highway to hell",
  "artist": "AC/DC",
  "year": 1981,
  "mood": "energetic"
}
```

Nous avons donc 2 documents !

Explorons cette base de donn√©es MongoDB !!!

C'est m√©ga excitant ü§£ü§£ü§£ !

## Requ√™tes dans MongoDB

Dans MongoDB, √©crire une requ√™te se r√©sume √† √©crire du JSON


| json                           | requ√™te                              |
| ------------------------------ | ------------------------------------ |
| `{}`                           | retourne tous les documents          |
| `{ field : value  }`           | o√π field = value                     |
| `{ field : { $lt : value }  }` | o√π field <= value   (lt : less than) |

Donc si nous voulons trouver tous les documents dans notre collection `songs`, √©crivez simplement '{}' dans le champ de requ√™te

Cela retourne nos 2 chansons.

![{} returns the whole dataset](./../img/query_musicdb.png)

Et la requ√™te `{ year: { $lt: 2000 } }` retourne la chanson qui a √©t√© publi√©e avant 2000.

![{ year : {$lt : 2000} } publi√©e avant 2000.](./../img/query_musicdb_year.png)

## Plussssss de donn√©es ! (moaaaaaarrrr data)

C'est bien mais nous avons besoin de plus de donn√©es pour pouvoir vraiment jouer.

Importons les jeux de donn√©es d'exemple fournis par ATLAS.

Allez dans `Clusters > dots > load sample dataset`

![load sample dataset](./../img/atlas_load_sample_dataset.png)

Puis cliquez sur le nom de votre projet (pour moi `Sandbox`) et `Browse collections` pour voir les bases de donn√©es disponibles.

Vous obtenez une nouvelle base de donn√©es `movies_mflix` avec 5 collections.

![Atlas sample databases](./../img/sample_datasetsets_atlas.png)

Regardez la collection `embedded_movies` qui contient 1525 documents et observez la structure d'un document

**Un document est un enregistrement JSON.**

Il peut avoir :

- du **JSON imbriqu√©** : regardez les dictionnaires imbriqu√©s `imdb` et les champs `tomatoes`.
- des **arrays** : regardez genres, cast, languages, writers, ...

**La cl√© primaire d'une collection est toujours "`_id`".**

```json
{
    "_id": {
        "$oid": "573a1390f29313caabcd5293"
    },
    "plot": "Young Pauline is left a lot of money when her wealthy uncle dies. However, her uncle's secretary has been named as her guardian until she marries, at which time she will officially take ...",
    "genres": [
        "Action"
    ],
    "runtime": {
        "$numberInt": "199"
    },
    "cast": [
        "Pearl White",
        "Crane Wilbur",
        "Paul Panzer",
        "Edward Jos√®"
    ],
    "num_mflix_comments": {
        "$numberInt": "0"
    },
    "poster": "https://m.media-amazon.com/images/M/MV5BMzgxODk1Mzk2Ml5BMl5BanBnXkFtZTgwMDg0NzkwMjE@._V1_SY1000_SX677_AL_.jpg",
    "title": "The Perils of Pauline",
    "fullplot": "Young Pauline is left a lot of money when her wealthy uncle dies. However, her uncle's secretary has been named as her guardian until she marries, at which time she will officially take possession of her inheritance. Meanwhile, her \"guardian\" and his confederates constantly come up with schemes to get rid of Pauline so that he can get his hands on the money himself.",
    "languages": [
        "English"
    ],
    "released": {
        "$date": {
            "$numberLong": "-1760227200000"
        }
    },
    "directors": [
        "Louis J. Gasnier",
        "Donald MacKenzie"
    ],
    "writers": [
        "Charles W. Goddard (screenplay)",
        "Basil Dickey (screenplay)",
        "Charles W. Goddard (novel)",
        "George B. Seitz",
        "Bertram Millhauser"
    ],
    "awards": {
        "wins": {
            "$numberInt": "1"
        },
        "nominations": {
            "$numberInt": "0"
        },
        "text": "1 win."
    },
    "lastupdated": "2015-09-12 00:01:18.647000000",
    "year": {
        "$numberInt": "1914"
    },
    "imdb": {
        "rating": {
            "$numberDouble": "7.6"
        },
        "votes": {
            "$numberInt": "744"
        },
        "id": {
            "$numberInt": "4465"
        }
    },
    "countries": [
        "USA"
    ],
    "type": "movie",
    "tomatoes": {
        "viewer": {
            "rating": {
                "$numberDouble": "2.8"
            },
            "numReviews": {
                "$numberInt": "9"
            }
        },
        "production": "Path√® Fr√®res",
        "lastUpdated": {
            "$date": {
                "$numberLong": "1441993579000"
            }
        }
    }
}
```

L'interface utilisateur ATLAS est bien faite mais je pr√©f√®re travailler avec du code plut√¥t qu'une interface web.

Passons √† python et √†  `mongosh` pour explorer cette base de donn√©es de films et apprendre √† faire des requ√™tes dans MongoDB.

## Se connecter via votre langage

Atlas vous permet de vous connecter √† votre cluster

![connect to your cluster](./../img/connect_to_cluster.png)

### Se connecter en Python

Nous avons besoin du package [pymongo](https://pypi.org/project/pymongo/)

```bash
pip install pymongo
```

La string de connexion est

```python
connection_string = "mongodb+srv://alexis:<db_password>@skatai.w932a.mongodb.net/?retryWrites=true&w=majority&appName=SkatAI"
```

Note : il est pr√©f√©rable de mettre la string de connexion comme variable d'environnement (`$MONGO_ATLAS_URI`), par exemple dans un fichier `.env`. puis la charger avec `dotenv`

```python
import os
from dotenv import load_dotenv

load_dotenv()

MONGO_ATLAS_URI = os.getenv('MONGO_ATLAS_URI')
```

Et ensuite d'instancier le client avec

```python
from pymongo import MongoClient

client = MongoClient(MONGO_ATLAS_URI)
```

Une fois que nous avons un client, nous pouvons nous connecter √† la base de donn√©es

```python
db = client["sample_mflix"]
```

puis instancier un objet collection

```python
collection = db["movies"]
```

L'objet collection est de la classe `pymongo.synchronous.collection.Collection` et poss√®de de nombreuses m√©thodes :

![many collections methods](./../img/collection_many_methods.png)

### Utiliser le terminal avec `mongosh`

Comment installer `mongosh` : <https://www.mongodb.com/docs/mongodb-shell/install/>

Le langage utilis√© dans le shell MongoDB (`mongosh`) est du JavaScript.

`mongosh` est une interface JavaScript interactive vers MongoDB, vous permettant d'interagir avec vos instances MongoDB, d'ex√©cuter des requ√™tes et d'effectuer des t√¢ches administratives en JavaScript.

`mongosh` prend √©galement en charge de nombreuses fonctionnalit√©s JavaScript y compris l'utilisation de variables, de boucles et de fonctions.


Voici quelques exemples d'utilisation de JavaScript dans `mongosh` :

- **Se connecter √† une instance MongoDB :**

```javascript
mongosh "mongodb://localhost:27017"
```

Une fois connect√© a une instance

- **Changer de base de donn√©es :**

```javascript
use myDatabase
```

- **Ins√©rer un document**

```javascript
db.myCollection.insertOne({ name: "Alice", age: 30 })
```

- **Executer une requ√™te**

```javascript
db.myCollection.find({ age: { $gt: 25 } })
```

- **Mettre √† jour un document**

```javascript
db.myCollection.updateOne({ name: "Alice" }, { $set: { age: 31 } })
```

- **Supprimer un document :**

```javascript
db.myCollection.deleteOne({ name: "Alice" })
```

- **Utiliser des variables et fonctions JavaScript**

```javascript
var name = "Alice";
db.myCollection.find({ name: name }).forEach(printjson);
```

`mongosh` est un outil puissant pour interroger et g√©rer vos bases de donn√©es MongoDB.

### Diff√©rence entre les requ√™tes en python et en javascript

python : double guillemets autour des champs et op√©rateurs

```python
db.movies.find(
    {"runtime": {"$gt" : 180}},  // Filter on movie duration
    { "_id": 0, "title": 1, "runtime": 1, "imdb.rating": 1 }  // Projection to include title and imdb.rating, exclude _id
)
```

`mongosh` : pas besoin de guillemets

```js
db.movies.find(
    {runtime: {$gt : 180}},  // Filter on movie duration
    { _id: 0, title: 1, runtime: 1, "imdb.rating": 1 }  // Projection to include title and imdb.rating, exclude _id
)
```

### Filtrage

<https://www.mongodb.com/docs/manual/reference/glossary/>

Le JSON qui sp√©cifie les arguments de filtrage est appel√© un **pr√©dicat de requ√™te (query predicate)**. C'est une expression qui renvoie un bool√©en indiquant si un document correspond √† la requ√™te sp√©cifi√©e.

Par exemple, `{ title: { $eq: "Top Gun" } }`, qui renvoie les documents qui ont un champ "title" dont la valeur est "Top Gun".

Un pr√©dicat de requ√™te vide (`{ }`) retourne tous les documents de la collection.

Fonctions principales sur les collections

| fonction              | retourne                                                                                      |
| --------------------- | --------------------------------------------------------------------------------------------- |
| `find()`              | tous les documents                                                                            |
| `find_one()`          | le 1er document                                                                               |
| `distinct("<field>")` | liste des valeurs distinctes pour le `<field>`                                                |
| `count_documents({})` | nombre de documents pour la collection ou retourn√©s par le filtre dans le pr√©dicat de requ√™te |

Notez aussi

- `find_one_and_replace()`
- `find_one_and_update()`
et

- `delete_many()`
- `delete_one()`
- `drop_index()`


Note : Vous pouvez √©galement interroger directement la collection depuis le client avec `db.<collection_name>.find()`

```bash
collection.find({})
# ou
db.movies.find({})
```

Vous pouvez cha√Æner ces m√©thodes avec `limit` et `sort`

```bash
db.movies.find({runtime: {$gt: 120}}).limit(3)
```

### Curseur

Le r√©sultat retourn√© est un **curseur**.

```js
cursor = db.movies.find({})
```

Un curseur est un pointeur sur un ensemble de r√©sultats de requ√™te MongoDB.


### Projection

Dans le langage des bases de donn√©es, **projeter** signifie s√©lectionner un sous-ensemble de tous les champs.

En SQL, vous listez simplement les noms des colonnes

```sql
select genres, plot from movies;
```

Dans MongoDB, il faut sp√©cifier  les champs dans un objet JSON, juste apr√®s le pr√©dicat de requ√™te

```json
db.movies.find(
    {runtime: {$gt : 180}},  // Filter on movie duration
    { _id: 0, title: 1, runtime: 1, "imdb.rating": 1 }  // Projection to include title and imdb.rating, exclude _id
)
```

Projection : `({ _id: 0, title: 1, runtime: 1, "imdb.rating": 1 })`

- `title: 1` : inclut le champ title.
- `runtime: 1,` inclut le runtime
- `"imdb.rating": 1` : Inclut le champ `imdb.rating`.
- `_id: 0` : Exclut le champ `_id` du r√©sultat (la valeur par d√©faut est 1 si non sp√©cifi√©).

La requ√™te retourne

```json
  { runtime: 240, title: 'Napoleon', imdb: { rating: 7.4 } },
  { runtime: 281, title: 'Les Mis√®rables', imdb: { rating: 7.9 } },
  { runtime: 245, title: 'Flash Gordon', imdb: { rating: 7.3 } },
  { runtime: 238, title: 'Gone with the Wind', imdb: { rating: 8.2 } },
```

### Exercices

#### En python
Ex√©cutons quelques requ√™tes en Python sur la base de donn√©es `movies`

```python
import os
from pymongo import MongoClient

connection_string = os.getenv('MONGO_ATLAS_URI')
client = MongoClient(connection_string)
db = client["sample_mflix"]
```

Ensuite

- R√©cup√©rer le titre et les genres des films qui ont le genre "Action".

```python
cursor = db.movies.find(
    {"genres": "Action"},  # Filter: movies with 'Action' in the genres array
    {"_id": 0, "title": 1, "genres": 1}  # Projection: include title and genres, exclude _id
)
```

pour voir les r√©sultats

```python
for movie in cursor:
    print(movie)
```

#### avec `mongosh` :

une fois connect√©

```js
cursor = db.movies.find(
    {"genres": "Action"},  # Filter: movies with 'Action' in the genres array
    {"_id": 0, "title": 1, "genres": 1}  # Projection: include title and genres, exclude _id
)
```

### Nombre de documents

La mani√®re la plus rapide de compter les documents est d'utiliser `count_documents`

```python
count = db.movies.count_documents({"imdb.rating": {"$gt": 8.0}})
```

> Note : en Python, vous pouvez cloner le curseur pour obtenir sa longueur et le nombre de documents retourn√©s.
> Cloner le curseur ne le consomme pas

```python
len(list(cursor.clone()))
```

#### avec mongosh

```js
db.movies.countDocuments({ "imdb.rating": { $gt: 8.0 } })
```

### √Ä vous de jouer

avec

```python
cursor = db.movies.find( filter, projection).limit(5)
for movie in cursor:
    print(movie)
```

√âcrivez le filtre et la projection pour les requ√™tes suivantes et retournez √©galement le nombre de documents avec `db.movies.count_documents(filter)`

- utilisez la projection pour ne retourner que les champs pertinents ou au minimum "title"
- limitez les r√©sultats √† 5 documents

1. Trouver les films avec une note IMDb sup√©rieure √† 8
   - filter : `{"imdb.rating": {"$gt" : 8}}`
   - projection : `{"_id": 0, "title": 1, "imdb.rating": 1}`
2. Films sortis apr√®s 2000
3. Films avec un r√©alisateur sp√©cifique : "Christopher Nolan". Montrer le titre, le r√©alisateur et l'ann√©e
4. R√©cup√©rer les films avec `tomatoes.viewer.rating > 4.0`, montrant le titre et la note des spectateurs.
5. Trouver les films qui contiennent `"Comedy"` et `"Drama"` dans le tableau `genres`. Utiliser `{$all: [list of genres]}`
6. Combiner une requ√™te avec un tri : R√©cup√©rer les 5 meilleurs films avec la note IMDb la plus √©lev√©e, montrant le titre et la note. (vous devez uniquement r√©cup√©rer `imdb.rating` avec le type de donn√©es `double`)
7. Requ√™te de films sur une plage d'ann√©es : R√©cup√©rer les films sortis entre 1990 et 2000, montrant le titre et l'ann√©e.
8. Requ√™te de films avec des champs manquants : Trouver les films o√π le champ `fullplot` n'existe pas. Utiliser `$exists`.
9. Trouver tous les genres distincts
   - utiliser `db.movies.distinct("genres")`
10. Films avec au moins 2 genres
    - utiliser `{"genres": {$size: 2}}`
11. Films du genre Action, apr√®s 1950 avec des notes imdb > 8, trier par ann√©e desc, note imdb desc
    - utiliser `{
      "year": {$gt: 1950},
      "imdb.rating": {$gt: 8},
      "genres": "Action"
    }`
12. Films avec les deux genres : Action et Drama
    - `$and: [
        {"genres": "Action"},
        {"genres": "Drama"}
    ]`
13. Films avec soit Action soit Drama
    - `$or: [
        {"genres": "Action"},
        {"genres": "Drama"}
    ]`
14. Films apr√®s 1950 avec soit imdb.rating > 0 soit awards.wins > 5
    - utiliser : `{
    "year": {$gt: 1950},
    $or: [
        {"imdb.rating": {$gt: 8}},
        {"awards.wins": {$gt: 5}}
    ]
}`

## Conclusion

Dans cette session vous avez pratiqu√© :

- La configuration de MongoDB Atlas, un service de base de donn√©es h√©berg√© dans le cloud, y compris la cr√©ation de cluster et la configuration de s√©curit√©

- L'√©criture de requ√™tes MongoDB de base utilisant le format JSON :
  - Syntaxe de base : `{}` pour tous les documents, `{field: value}` pour l'√©galit√©, `{field: {$lt: value}}` pour les comparaisons
  - Comment interroger les champs imbriqu√©s et les tableaux dans des documents complexes

- La connexion √† MongoDB Atlas en utilisant Python et `pymongo` :
  - Utilisation des op√©rations de base : `find()`, `find_one()`, `distinct()`, `count_documents()`
  - Impl√©mentation des projections pour s√©lectionner des champs sp√©cifiques

- Le travail avec des jeux de donn√©es d'exemple (particuli√®rement la base de donn√©es movies) pour pratiquer :
  - Le filtrage et le tri des donn√©es
  - Le travail avec des champs imbriqu√©s
  - L'utilisation d'op√©rateurs comme `$gt`, `$lt`, `$all`, `$exists`
  - L'√©criture de requ√™tes combin√©es avec plusieurs conditions

Dans la prochaine session, nous plongerons plus profond√©ment dans MongoDB et examinerons des fa√ßons plus complexes d'interroger les donn√©es en utilisant les **pipelines d'agr√©gation**. Nous aborderons √©galement la conception et la validation des sch√©mas.

## Pour aller plus loin

Pour la prochaine fois, vous pouvez :

- explorer davantage les bases de donn√©es exemple d'Atlas et pratiquer l'√©criture de requ√™tes
- suivre https://www.mongodb.com/docs/languages/python/pymongo-driver/current/read/ pour plus de pratique
- Il y a de nombreux cours et tutoriels gratuits dans l'universit√© MongoDB
  - [Intro to MongoDB](https://learn.mongodb.com/learning-paths/introduction-to-mongodb)
  - [CRUD in python](https://learn.mongodb.com/learn/course/mongodb-crud-operations-in-python/lesson-2-inserting-a-document-in-python-applications/learn)

et bien plus encore